--- a/ext/zlib/php_zlib.h
+++ b/ext/zlib/php_zlib.h
@@ -52,8 +52,10 @@ ZEND_BEGIN_MODULE_GLOBALS(zlib)
 	int compression_coding;
 	long output_compression;
 	long output_compression_level;
+	long output_compression_default;
 	char *output_handler;
 	php_zlib_context *ob_gzhandler;
+    zend_bool handler_registered;
 ZEND_END_MODULE_GLOBALS(zlib);
 
 php_stream *php_stream_gzopen(php_stream_wrapper *wrapper, char *path, char *mode, int options, char **opened_path, php_stream_context *context STREAMS_DC TSRMLS_DC);
--- a/ext/zlib/zlib.c
+++ b/ext/zlib/zlib.c
@@ -263,6 +263,8 @@ static php_output_handler *php_zlib_outp
 		ZLIBG(output_compression) = chunk_size ? chunk_size : PHP_OUTPUT_HANDLER_DEFAULT_SIZE;
 	}
 
+    ZLIBG(handler_registered) = 1;
+
 	if ((h = php_output_handler_create_internal(handler_name, handler_name_len, php_zlib_output_handler, chunk_size, flags TSRMLS_CC))) {
 		php_output_handler_set_context(h, php_zlib_output_handler_context_init(TSRMLS_C), php_zlib_output_handler_context_dtor TSRMLS_CC);
 	}
@@ -890,6 +892,7 @@ static PHP_INI_MH(OnUpdate_zlib_output_c
 
 	status = OnUpdateLong(entry, new_value, new_value_length, mh_arg1, mh_arg2, mh_arg3, stage TSRMLS_CC);
 
+	ZLIBG(output_compression) = ZLIBG(output_compression_default);
 	if (stage == PHP_INI_STAGE_RUNTIME && int_value) {
 		if (!php_output_handler_started(ZEND_STRL(PHP_ZLIB_OUTPUT_HANDLER_NAME) TSRMLS_CC)) {
 			php_zlib_output_compression_start(TSRMLS_C);
@@ -914,7 +917,7 @@ static PHP_INI_MH(OnUpdate_zlib_output_h
  
 /* {{{ INI */
 PHP_INI_BEGIN()
-	STD_PHP_INI_BOOLEAN("zlib.output_compression",      "0", PHP_INI_ALL, OnUpdate_zlib_output_compression,       output_compression,       zend_zlib_globals, zlib_globals)
+	STD_PHP_INI_BOOLEAN("zlib.output_compression",      "0", PHP_INI_ALL, OnUpdate_zlib_output_compression,       output_compression_default,       zend_zlib_globals, zlib_globals)
 	STD_PHP_INI_ENTRY("zlib.output_compression_level", "-1", PHP_INI_ALL, OnUpdateLong,                           output_compression_level, zend_zlib_globals, zlib_globals)
 	STD_PHP_INI_ENTRY("zlib.output_handler",             "", PHP_INI_ALL, OnUpdate_zlib_output_handler,           output_handler,           zend_zlib_globals, zlib_globals)
 PHP_INI_END()
@@ -958,8 +961,10 @@ static PHP_MSHUTDOWN_FUNCTION(zlib)
 static PHP_RINIT_FUNCTION(zlib)
 {
 	ZLIBG(compression_coding) = 0;
-
-	php_zlib_output_compression_start(TSRMLS_C);
+    if (!ZLIBG(handler_registered)) {
+        ZLIBG(output_compression) = ZLIBG(output_compression_default);
+        php_zlib_output_compression_start(TSRMLS_C);
+    }
 
 	return SUCCESS;
 }
@@ -968,6 +973,7 @@ static PHP_RINIT_FUNCTION(zlib)
 static PHP_RSHUTDOWN_FUNCTION(zlib)
 {
 	php_zlib_cleanup_ob_gzhandler_mess(TSRMLS_C);
+    ZLIBG(handler_registered) = 0;
 
     return SUCCESS;
 }
@@ -991,6 +997,7 @@ static PHP_MINFO_FUNCTION(zlib)
 static ZEND_MODULE_GLOBALS_CTOR_D(zlib)
 {
 	zlib_globals->ob_gzhandler = NULL;
+    zlib_globals->handler_registered = 0;
 }
 /* }}} */
 
